---
title: "NoSSHでSSMを試したら、セキュリティグループの最小構成で混乱した話"
emoji: "🐕"
type: "tech"
topics: ["aws", "ssm"]
published: true
---

## はじめに
AWSではEC2をSSHなしで管理できるAWS Systems Manager（SSM）が推奨されている。
NoSSHを試したいと思い、SSMが動作するAmazon Linux2で、久しぶりにEC2を立ち上げてみた。
その際に、セキュリティグループ（SG）に何をどこまで設定すればよいのか疑問に思ったため、本記事で整理する。

### NoSSH実現のためのSGの考え方
NoSSH環境では、できるだけポートを開けないことが前提となる。
22番ポートを開けずに通信が可能になるということは、「SSMを使うために、どこまで通信を許可すればいいのか？」を考える必要がある。

そこで、調べてみたところAWSの公式ドキュメントや技術記事では、一般的に次のように説明されている。

- パブリックIPがあれば、SSMエンドポイントへ直接接続可能
- NATゲートウェイを経由すれば、パブリックIPを通じてSSMに接続可能
- VPCエンドポイントを利用すれば、プライベートネットワーク内でSSMを利用可能

しかし、どのケースでどこまで通信を制限できるのかについては、明確な説明が少なかった。
そこで、実際に試して整理してみることにした。

### セキュリティグループ（SG）のデフォルト動作
| **項目** | **デフォルトの動作** |
|------|------|
| **インバウンド** | すべて拒否（明示的な許可がない限り、受信トラフィックを拒否） |
| **アウトバウンド** | すべて許可（明示的な制限がない限り、送信トラフィックを許可） |

SGのデフォルト設定をベースに、何をどこまで設定すべきかを考えてみる。

### SSMを最小限の許可で利用するためのSG設定
| **ネットワーク構成** | **通信の出口** | **インバウンドルールの変更** | **アウトバウンドルールの変更** | **最小構成で許可すべき範囲** |
|------|------|------|------|------|
| **パブリックIPあり（パブリックサブネット）** | インターネット（SSMエンドポイントへ直接通信） | なし（すべて拒否でOK） | **`ssm.<region>.amazonaws.com` のみ許可** | **インバウンド不要 / アウトバウンドをSSMエンドポイントに限定** |
| **NATゲートウェイ経由（プライベートサブネット）** | NATゲートウェイ | なし（すべて拒否でOK） | **NATゲートウェイ経由でSSMエンドポイントのみ許可** | **インバウンド不要 / アウトバウンドをNAT経由のSSMエンドポイントに限定** |
| **VPCエンドポイント経由（プライベートサブネット、パブリックIPなし）** | VPCエンドポイント（Interface型） | **VPCエンドポイントのSGからのインバウンド許可が必須** | **VPCエンドポイントのSGへのアウトバウンド許可が必須** | **双方向のSG許可が必須 / インバウンドをVPCエンドポイントSGのみに制限** |

### どこまで許可すべきか？
NoSSH環境では、できるだけ余計な通信を発生させないことが望ましい。そのため、最低限の設定として以下を考える。

- インバウンド
  - パブリックIPあり / NATゲートウェイ経由では変更不要（すべて拒否のままで問題なし）
  - **VPCエンドポイント経由のみ、インバウンド許可が必要**
- アウトバウンド
  - ssm.<region>.amazonaws.comのみに制限すれば、よりセキュア
  - ただし、運用要件に応じて柔軟にするのもあり。そのため、デフォルトのアウトバウンドの設定に近い構成になりがち。

パブリックIPありやNATゲートウェイ経由では、デフォルトのSG設定で問題なく動作する。
VPCエンドポイント経由のみ、インバウンドの許可が必要になるため、ここが設定のポイントとなる。

## まとめ
NoSSH環境でSSMを利用する際、最小限のSG設定を考えると次のようになる。

- パブリックIPあり & NATゲートウェイ経由
  - インバウンドはデフォルトのままで問題なし
  - アウトバウンドをSSMエンドポイントのみに制限するのが望ましいが、運用次第で柔軟に
- VPCエンドポイント経由のみ、インバウンドの許可が必須
  - EC2のSG → VPCエンドポイントのSGへのアウトバウンド許可が必要
  - VPCエンドポイントのSG → EC2のSGへのインバウンド許可が必要
  - このVPCエンドポイントのSG設定が、ハマりどころになる

つまり、インバウンドとアウトバウンドは、デフォルトのSG設定でほぼSSM経由の通信が可能になる。
そのため、調べると「許可が必要」という情報と、「デフォルトで動作する」という情報の両方が見つかるが、パブリックIPやNAT経由では特に問題なく動くことがわかった。

結局、SGで気にすべきなのはVPCエンドポイントの設定だけだった。これは、パブリックIPを持たないEC2が外部通信をするためには、VPCエンドポイントを明示的に許可する必要があるためだ。そのため、VPCエンドポイント経由の構成は情報が少なく、理解しづらい部分があることもわかった。

##　おわりに
この構成を試すことで、パブリックIPなしのEC2がどこまで制約を受けるのかについても理解が深まった。ただし、現実的にこの用途でEC2を運用するケースがどの程度あるのかはシチュエーションによる。例えば `yum install git`はできても、`git clone`はできない構成ができあがる。

また、今回の検証中に、NATとVPCエンドポイントを併用するとトラブルが発生しやすいこともわかった。基本的にはどちらかに絞って運用するのが無難だと感じた。

### 参考にしたAWS公式ドキュメント
1. [AWS Systems Manager Agent](https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html)
2. [Create a VPC endpoint - AWS PrivateLink](https://docs.aws.amazon.com/vpc/latest/privatelink/create-interface-endpoint.html)
3. [NAT ゲートウェイの概要](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html)
